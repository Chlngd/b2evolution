tinymce.PluginManager.add("evo_view",function(a){function b(a,b){for(;a&&a.parentNode;){if(a.className&&-1!==(" "+a.className+" ").indexOf(" "+b+" "))return a;a=a.parentNode}return!1}function c(a){return b(a,"evo-view-wrap")}function d(){var b;if(p&&(b=p.getAttribute("data-evo-view-type")),-1==E.indexOf(b))return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="'+evo_js_lang_loading+'..."></span>',"80%","",!0,evo_js_lang_select_image_insert,"",!0),jQuery.ajax({type:"POST",url:a.getParam("modal_url"),success:function(b){openModalWindow(b,"90%","80%",!0,"Select image","","","","","",function(){var b,c;void 0==a.getParam("temp_ID")?(b=a.getParam("target_type"),c=a.getParam("target_ID")):(b="temporary",c=a.getParam("temp_ID")),evo_link_refresh_list(b,c),evo_link_fix_wrapper_height()})}}),!1;var c=decodeURIComponent(o.getAttribute("data-evo-view-text"));evo_item_image_edit(a.settings.blog_ID,c)}function e(a){a.stopPropagation()}function f(b,c){var d=b?"before":"after",e=b?0:1;j(),a.selection.setCursorLocation(a.dom.select(".evo-view-selection-"+d,c)[0],e),a.nodeChanged()}function g(b,c,d){var e=a.dom,g=e.create("p");y.ie&&y.ie<11||(g.innerHTML='<br data-mce-bogus="1">'),c?b.parentNode.insertBefore(g,b):e.insertAfter(g,b),j(),c&&d===z.ENTER?f(c,b):a.selection.setCursorLocation(g,0),a.nodeChanged()}function h(b){a.undoManager.transact(function(){evo.views.remove(a,b)})}function i(b){var d,f=a.dom;b&&(b!==o&&(a.getBody().focus(),j(),o=b,p=c(b),f.setAttrib(b,"data-mce-selected",1),f.addClass(o,"evo-view-selected"),d=f.create("div",{class:"evo-view-clipboard",contenteditable:"true"},evo.views.getText(b)),a.dom.select(".evo-view-body",b)[0].appendChild(d),f.bind(d,"beforedeactivate focusin focusout",e),f.bind(o,"beforedeactivate focusin focusout",e),D?a.selection.select(d):a.selection.select(d,!0)),a.nodeChanged(),a.fire("evo-view-selected",b))}function j(){var b,c=a.dom;o&&(b=a.dom.select(".evo-view-clipboard",o)[0],c.unbind(b),c.remove(b),c.unbind(o,"beforedeactivate focusin focusout click mouseup",e),c.setAttrib(o,"data-mce-selected",null),c.removeClass(o,"evo-view-selected")),o=null,p=null}function k(a,b){return window.decodeURIComponent(b)}function l(a){return a.replace(/<(?:div|span)[^>]+data-evo-view-text="([^"]+)"[^>]*>(?:[\s\S]+?evo-view-selection-after[^>]+>[^<>]*<\/p>\s*|\.)<\/(?:div|span)>/g,k).replace(/<p [^>]*?data-evo-view-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,k)}function m(a){x("div[data-evo-view-text], span[data-evo-view-text], p[data-evo-view-marker]",a).each(function(a,b){b.innerHTML="."})}function n(a){return a<=47&&a!==z.SPACEBAR&&a!==z.ENTER&&a!==z.DELETE&&a!==z.BACKSPACE&&(a<37||a>40)||a>=224||a>=144&&a<=150||a>=91&&a<=93||a>=112&&a<=135}var o,p,q,r,s,t,u,v,w,x=a.$,y=tinymce.Env,z=tinymce.util.VK,A=tinymce.dom.TreeWalker,B=!1,C=!0,D=/iPad|iPod|iPhone/.test(navigator.userAgent),E=["image","thumbnail","inline"];return a.on("BeforeAddUndo",function(a){a.level.content&&(a.level.content=l(a.level.content))}),a.on("BeforeSetContent",function(b){var c;if(b.selection||evo.views.unbind(),b.content){if(!b.load&&(o&&(h(o),j()),(c=a.selection.getNode())&&c!==a.getBody()&&/^\s*https?:\/\/\S+\s*$/i.test(b.content))){if(!(c=a.dom.getParent(c,"p"))||!/^[\s\uFEFF\u00A0]*$/.test(x(c).text()||""))return;c.innerHTML=""}b.content=evo.views.setMarkers(b.content)}}),a.on("pastePreProcess",function(a){var b=a.content;b&&(b=tinymce.trim(b.replace(/<[^>]+>/g,"")),/^https?:\/\/\S+$/i.test(b)&&(a.content=b))}),a.on("SetContent",function(){evo.views.render()}),a.on("click",function(b){var d,e,g,h=b.clientX,i=b.clientY,j=a.getBody(),k=j.getBoundingClientRect(),l=j.firstChild,m=j.lastChild;l&&m&&(d=l.getBoundingClientRect(),e=m.getBoundingClientRect(),i<d.top&&(g=c(l))?(f(!0,g),b.preventDefault()):i>e.bottom&&(g=c(m))?(f(!1,g),b.preventDefault()):(h<k.left||h>k.right)&&tinymce.each(a.dom.select(".evo-view-wrap"),function(a){var c=a.getBoundingClientRect();return!(i<c.top)&&(i>=c.top&&i<=c.bottom?(h<k.left?(f(!0,a),b.preventDefault()):h>k.right&&(f(!1,a),b.preventDefault()),!1):void 0)}))}),a.on("init",function(){var b=!1,d=a.selection,e=window.MutationObserver||window.WebKitMutationObserver;a.on("BeforeSetContent",function(){var b,e,f=c(d.getNode());f&&(!f.nextSibling||c(f.nextSibling)?(e=a.getDoc().createTextNode(""),a.dom.insertAfter(e,f)):(b=new A(f.nextSibling,f.nextSibling),e=b.next()),d.select(e),d.collapse(!0))}),a.dom.bind(a.getDoc(),"touchmove",function(){b=!0}),a.on("dblclick",function(d){var e=c(d.target);if(e){d.stopImmediatePropagation(),d.preventDefault(),"touchend"===d.type&&b?b=!1:i(e),p&&(viewType=p.getAttribute("data-evo-view-type"));var f=decodeURIComponent(o.getAttribute("data-evo-view-text"));return evo_item_image_edit(a.settings.blog_ID,f),!1}}),a.on("mousedown mouseup click touchend",function(a){var d=c(a.target);if(C=!1,d)return a.stopImmediatePropagation(),a.preventDefault(),"touchend"===a.type&&b?b=!1:i(d),!1;"touchend"!==a.type&&"mousedown"!==a.type||j(),"touchend"===a.type&&b&&(b=!1)},!0),e&&new e(function(){a.fire("evo-body-class-change")}).observe(a.getBody(),{attributes:!0,attributeFilter:["class"]}),tinymce.Env.ie&&a.dom.bind(a.getBody(),"controlselect mscontrolselect",function(a){c(a.target)&&a.preventDefault()})}),a.on("PreProcess",function(a){m(a.node)},!0),a.on("hide",function(){evo.views.unbind(),j(),m()}),a.on("PostProcess",function(a){a.content&&(a.content=a.content.replace(/<(?:div|span) [^>]*?data-evo-view-text="([^"]+)"[^>]*>[\s\S]*?<\/(?:div|span)>/g,k).replace(/<p [^>]*?data-evo-view-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,k))}),a.on("keydown",function(b){var d,e,i,k,l,m=b.keyCode,p=(a.dom,a.selection);if(o){if((b.metaKey||b.ctrlKey)&&m!==z.BACKSPACE&&86!==m||m>=112&&m<=123)return void((b.metaKey||b.ctrlKey)&&88===m&&(B=o));if((e=c(p.getNode()))!==o)return void j();m===z.LEFT?(f(!0,e),b.preventDefault()):m===z.UP?(e.previousSibling?c(e.previousSibling)?f(!0,e.previousSibling):(j(),p.select(e.previousSibling,!0),p.collapse()):f(!0,e),b.preventDefault()):m===z.RIGHT?(f(!1,e),b.preventDefault()):m===z.DOWN?(e.nextSibling?c(e.nextSibling)?f(!1,e.nextSibling):(j(),p.setCursorLocation(e.nextSibling,0)):f(!1,e),b.preventDefault()):n(m)||(m===z.ENTER?(g(e,!1,m),b.preventDefault()):m===z.DELETE?(h(o),j(),b.preventDefault()):m===z.BACKSPACE&&(previousView=c(e.previousElementSibling),previousView?h(previousView):e.previousSibling?(p.setCursorLocation(e.previousSibling),j()):e.parentNode.previousSibling&&(p.setCursorLocation(e.parentNode.previousSibling,1),j())))}else{if(b.metaKey||b.ctrlKey||m>=112&&m<=123)return;if(d=p.getNode(),r=d,e=c(d),p.isCollapsed()||(i=p.getRng(),(e=c(i.endContainer))?(k=i.cloneRange(),p.select(e.previousSibling,!0),p.collapse(),l=p.getRng(),k.setEnd(l.endContainer,l.endOffset),p.setRng(k)):(e=c(i.startContainer))&&(k=i.cloneRange(),k.setStart(e.nextSibling,0),p.setRng(k))),!e)return void(m===z.BACKSPACE&&(a.dom.isEmpty(d)?(e=c(d.previousSibling))&&(f(!1,e),a.dom.remove(d),b.preventDefault()):(i=p.getRng())&&0===i.startOffset&&0===i.endOffset&&(e=c(d.previousSibling))&&(f(!1,e),b.preventDefault())));if(n(m))return;m===z.ENTER&&b.preventDefault()}}),a.on("keyup",function(){var d=event.keyCode,e=a.dom,f=a.selection,g=f.getNode();view=c(g),view&&(beforeView=e.hasClass(g,"evo-view-selection-before"),afterView=e.hasClass(g,"evo-view-selection-after"),console.log(beforeView,afterView),d===z.RIGHT||d===z.DOWN?beforeView?i(view):afterView&&(viewWrapper=b(g,"evo-view-wrap"),nextView=c(viewWrapper.nextElementSibling),nextView?i(nextView):viewWrapper.nextSibling?f.setCursorLocation(viewWrapper.nextSibling):viewWrapper.parentNode.nextSibling&&f.setCursorLocation(viewWrapper.parentNode.nextSibling)):d!==z.LEFT&&d!==z.UP||(beforeView?(viewWrapper=b(g,"evo-view-wrap"),previousView=c(viewWrapper.previousElementSibling),previousView?i(previousView):viewWrapper.previousSibling?f.setCursorLocation(viewWrapper.previousSibling):viewWrapper.parentNode.previousSibling&&f.setCursorLocation(viewWrapper.parentNode.previousSibling,1)):afterView&&i(view))),B&&(h(B),j(),B=!1)}),a.on("focus",function(){var b;t=!0,a.dom.addClass(a.getBody(),"has-focus"),C&&(b=c(a.getBody().firstChild))&&f(!0,b),C=!1}),a.on("blur",function(){t=!1,a.dom.removeClass(a.getBody(),"has-focus")}),a.on("NodeChange",function(d){var e=a.dom,g=a.dom.select(".evo-view-wrap"),h=d.element.className,i=c(d.element),k=r;if(r=!1,clearInterval(q),tinymce.each(g,function(a){a.className&&(a.className=a.className.replace(/ ?\bevo-view-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),t&&i)if("evo-view-selection-before"!==h&&"evo-view-selection-after"!==h||!a.selection.isCollapsed())b(d.element,"evo-view-clipboard")||s||(j(),s++,f(!0,i));else{if(s=0,j(),k===i.previousSibling)return void f(!0,i);if(k===i.nextSibling)return void f(!1,i);e.addClass(i,h),q=setInterval(function(){e.hasClass(i,"evo-view-cursor-hide")?e.removeClass(i,"evo-view-cursor-hide"):e.addClass(i,"evo-view-cursor-hide")},500)}}),a.on("BeforeExecCommand",function(){var b,d=a.selection.getNode();d&&((v="evo-view-selection-before"===d.className)||"evo-view-selection-after"===d.className)&&(b=c(d))&&(g(b,v),u=b)}),a.on("ExecCommand",function(){var b,c;o&&(b=o,j(),i(b)),u&&(c=u[v?"previousSibling":"nextSibling"],c&&"P"===c.nodeName&&a.dom.isEmpty(c)&&(a.dom.remove(c),f(v,u)),u=!1)}),a.on("ResolveName",function(b){a.dom.hasClass(b.target,"evo-view-wrap")?(b.name=a.dom.getAttrib(b.target,"data-evo-view-type")||"evo-view",b.stopPropagation()):c(b.target)&&(b.preventDefault(),b.stopPropagation())}),a.addButton("evo_image",{text:"inline image",icon:!1,tooltip:evo_js_lang_edit_image,onclick:function(){switch(a.getParam("target_type")){case"Item":if(!a.getParam("target_ID")&&!a.getParam("temp_ID"))return alert(evo_js_lang_alert_before_insert_item),!1;break;case"Comment":if(!a.getParam("target_ID"))return alert(evo_js_lang_alert_before_insert_comment),!1;break;case"EmailCampaign":if(!a.getParam("target_ID"))return alert(evo_js_lang_alert_before_insert_emailcampaign),!1;break;case"Message":if(!a.getParam("target_ID")&&!a.getParam("temp_ID"))return alert(evo_js_lang_alert_before_insert_message),!1}d()},onPostRender:function(){var b=this;a.on("NodeChange",function(a){var c;p&&(c=p.getAttribute("data-evo-view-type"));var d=-1!=E.indexOf(c);b.active(d)})}}),a.on("evotoolbar",function(a){o&&(a.element=o,a.toolbar=w)}),a.evo=a.evo||{},a.evo.getView=c,a.evo.setViewCursor=f,a.addCommand("evo_view_edit_inline",function(){d()}),{getView:c,editView:d}});