tinymce.PluginManager.add("evo_view",function(d){var u,i,r,g,s,l,n,o,a=d.$,c=tinymce.Env,f=tinymce.util.VK,v=tinymce.dom.TreeWalker,p=!1,m=!0,b=/iPad|iPod|iPhone/.test(navigator.userAgent),_=["image","thumbnail","inline"];function w(e,t){for(;e&&e.parentNode;){if(e.className&&-1!==(" "+e.className+" ").indexOf(" "+t+" "))return e;e=e.parentNode}return!1}function C(e){return w(e,"evo-view-wrap")}function e(){var e;if(i&&(e=i.getAttribute("data-evo-view-type")),-1==_.indexOf(e))return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="'+evo_js_lang_loading+'..."></span>',"80%","",!0,evo_js_lang_select_image_insert,"",!0),jQuery.ajax({type:"POST",url:d.getParam("modal_url"),success:function(e){openModalWindow(e,"90%","80%",!0,"Select image","","","","","",function(){var e,t;t=null==d.getParam("temp_ID")?(e=d.getParam("target_type"),d.getParam("target_ID")):(e="temporary",d.getParam("temp_ID")),evo_link_refresh_list(e,t),evo_link_fix_wrapper_height()})}}),!1;var t=decodeURIComponent(u.getAttribute("data-evo-view-text"));evo_item_image_edit(d.settings.blog_ID,t)}function S(e){e.stopPropagation()}function y(e,t){var n=e?"before":"after",o=e?0:1;x(),d.selection.setCursorLocation(d.dom.select(".evo-view-selection-"+n,t)[0],o),d.nodeChanged()}function P(e,t,n){var o=d.dom,i=o.create("p");c.ie&&c.ie<11||(i.innerHTML='<br data-mce-bogus="1">'),t?e.parentNode.insertBefore(i,e):o.insertAfter(i,e),x(),t&&n===f.ENTER?y(t,e):d.selection.setCursorLocation(i,0),d.nodeChanged()}function h(e){d.undoManager.transact(function(){evo.views.remove(d,e),x()})}function D(e){var t,n=d.dom;e&&(e!==u&&(d.getBody().focus(),x(),i=C(u=e),n.setAttrib(e,"data-mce-selected",1),n.addClass(u,"evo-view-selected"),t=n.create("div",{class:"evo-view-clipboard",contenteditable:"true"},evo.views.getText(e)),d.dom.select(".evo-view-body",e)[0].appendChild(t),n.bind(t,"beforedeactivate focusin focusout",S),n.bind(u,"beforedeactivate focusin focusout",S),b?d.selection.select(t):d.selection.select(t,!0)),d.nodeChanged(),d.fire("evo-view-selected",e))}function x(){var e,t=d.dom;u&&(e=d.dom.select(".evo-view-clipboard",u)[0],t.unbind(e),t.remove(e),t.unbind(u,"beforedeactivate focusin focusout click mouseup",S),t.setAttrib(u,"data-mce-selected",null),t.removeClass(u,"evo-view-selected")),i=u=null}function t(e,t){return window.decodeURIComponent(t)}function E(e){a("div[data-evo-view-text], span[data-evo-view-text], p[data-evo-view-marker]",e).each(function(e,t){t.innerHTML="."})}function A(e){return e<=47&&e!==f.SPACEBAR&&e!==f.ENTER&&e!==f.DELETE&&e!==f.BACKSPACE&&(e<37||40<e)||224<=e||144<=e&&e<=150||91<=e&&e<=93||112<=e&&e<=135}return d.on("BeforeAddUndo",function(e){e.level.content&&(e.level.content=e.level.content.replace(/<(?:div|span)[^>]+data-evo-view-text="([^"]+)"[^>]*>(?:[\s\S]+?evo-view-selection-after[^>]+>[^<>]*<\/p>\s*|\.)<\/(?:div|span)>/g,t).replace(/<p [^>]*?data-evo-view-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,t))}),d.on("BeforeSetContent",function(e){var t;if(e.selection||evo.views.unbind(),e.content){if(!e.load&&(u&&h(u),(t=d.selection.getNode())&&t!==d.getBody()&&/^\s*https?:\/\/\S+\s*$/i.test(e.content))){if(!(t=d.dom.getParent(t,"p"))||!/^[\s\uFEFF\u00A0]*$/.test(a(t).text()||""))return;t.innerHTML=""}e.content=evo.views.setMarkers(e.content)}}),d.on("pastePreProcess",function(e){var t=e.content;t&&(t=tinymce.trim(t.replace(/<[^>]+>/g,"")),/^https?:\/\/\S+$/i.test(t)&&(e.content=t))}),d.on("SetContent",function(){evo.views.render()}),d.on("click",function(n){var e,t,o,i=n.clientX,a=n.clientY,r=d.getBody(),s=r.getBoundingClientRect(),l=r.firstChild,c=r.lastChild;l&&c&&(e=l.getBoundingClientRect(),t=c.getBoundingClientRect(),a<e.top&&(o=C(l))?(y(!0,o),n.preventDefault()):a>t.bottom&&(o=C(c))?(y(!1,o),n.preventDefault()):(i<s.left||i>s.right)&&tinymce.each(d.dom.select(".evo-view-wrap"),function(e){var t=e.getBoundingClientRect();return!(a<t.top)&&(a>=t.top&&a<=t.bottom?(i<s.left?(y(!0,e),n.preventDefault()):i>s.right&&(y(!1,e),n.preventDefault()),!1):void 0)}))}),d.on("init",function(){var o=!1,n=d.selection,e=window.MutationObserver||window.WebKitMutationObserver;d.on("BeforeSetContent",function(){var e,t=C(n.getNode());t&&(!t.nextSibling||C(t.nextSibling)?(e=d.getDoc().createTextNode(""),d.dom.insertAfter(e,t)):e=new v(t.nextSibling,t.nextSibling).next(),n.select(e),n.collapse(!0))}),d.dom.bind(d.getDoc(),"touchmove",function(){o=!0}),d.on("dblclick",function(e){var t=C(e.target);if(t){e.stopImmediatePropagation(),e.preventDefault(),"touchend"===e.type&&o?o=!1:D(t),i&&(viewType=i.getAttribute("data-evo-view-type"));var n=decodeURIComponent(u.getAttribute("data-evo-view-text"));return evo_item_image_edit(d.settings.blog_ID,n),!1}}),d.on("mousedown mouseup click touchend",function(e){var t=C(e.target);if(m=!1,t)return e.stopImmediatePropagation(),e.preventDefault(),"touchend"===e.type&&o?o=!1:D(t),!1;"touchend"!==e.type&&"mousedown"!==e.type||x(),"touchend"===e.type&&o&&(o=!1)},!0),e&&new e(function(){d.fire("evo-body-class-change")}).observe(d.getBody(),{attributes:!0,attributeFilter:["class"]}),tinymce.Env.ie&&d.dom.bind(d.getBody(),"controlselect mscontrolselect",function(e){C(e.target)&&e.preventDefault()})}),d.on("PreProcess",function(e){E(e.node)},!0),d.on("hide",function(){evo.views.unbind(),x(),E()}),d.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<(?:div|span) [^>]*?data-evo-view-text="([^"]+)"[^>]*>[\s\S]*?<\/(?:div|span)>/g,t).replace(/<p [^>]*?data-evo-view-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,t))}),d.on("keydown",function(e){var t,n,o,i,a,r,s,l=e.keyCode,c=d.dom,v=d.selection;if(u){if((e.metaKey||e.ctrlKey)&&l!==f.BACKSPACE&&86!==l||112<=l&&l<=123)return void((e.metaKey||e.ctrlKey)&&88===l&&(p=u));if((n=C(v.getNode()))!==u)return void x();l===f.LEFT?(y(!0,n),e.preventDefault()):l===f.UP?(n.previousSibling?C(n.previousSibling)?y(!0,n.previousSibling):(x(),v.select(n.previousSibling,!0),v.collapse()):y(!0,n),e.preventDefault()):l===f.RIGHT?(y(!1,n),e.preventDefault()):l===f.DOWN?(n.nextSibling?C(n.nextSibling)?y(!1,n.nextSibling):(x(),v.setCursorLocation(n.nextSibling,0)):y(!1,n),e.preventDefault()):A(l)||(h(u),l!==f.ENTER&&l!==f.DELETE&&l!==f.BACKSPACE||e.preventDefault())}else{if(e.metaKey||e.ctrlKey||112<=l&&l<=123)return;if(t=v.getNode(),n=C(g=t),v.isCollapsed()||((n=C((a=v.getRng()).endContainer))?(r=a.cloneRange(),v.select(n.previousSibling,!0),v.collapse(),s=v.getRng(),r.setEnd(s.endContainer,s.endOffset),v.setRng(r)):(n=C(a.startContainer))&&((r=a.cloneRange()).setStart(n.nextSibling,0),v.setRng(r))),!n)return void(e.keyCode===f.BACKSPACE&&(d.dom.isEmpty(t)?(n=C(t.previousSibling))&&(y(!1,n),d.dom.remove(t),e.preventDefault()):(a=v.getRng())&&0===a.startOffset&&0===a.endOffset&&(n=C(t.previousSibling))&&(y(!1,n),e.preventDefault())));if(!(o=c.hasClass(n,"evo-view-selection-before"))&&!(i=c.hasClass(n,"evo-view-selection-after")))return;if(A(l))return;i&&l===f.UP||o&&l===f.BACKSPACE?(n.previousSibling?C(n.previousSibling)?y(!1,n.previousSibling):c.isEmpty(n.previousSibling)&&l===f.BACKSPACE?c.remove(n.previousSibling):(v.select(n.previousSibling,!0),v.collapse()):y(!0,n),e.preventDefault()):!i||l!==f.DOWN&&l!==f.RIGHT?!o||l!==f.UP&&l!==f.LEFT?o&&l===f.DOWN?(n.nextSibling?C(n.nextSibling)?y(!0,n.nextSibling):v.setCursorLocation(n.nextSibling,0):y(!1,n),e.preventDefault()):i&&l===f.LEFT||o&&l===f.RIGHT?(D(n),e.preventDefault()):i&&l===f.BACKSPACE?(h(n),e.preventDefault()):i?P(n):o&&P(n,!0,l):(n.previousSibling&&(C(n.previousSibling)?y(l===f.UP,n.previousSibling):(v.select(n.previousSibling,!0),v.collapse())),e.preventDefault()):(n.nextSibling&&(C(n.nextSibling)?y(l===f.RIGHT,n.nextSibling):v.setCursorLocation(n.nextSibling,0)),e.preventDefault()),l===f.ENTER&&e.preventDefault()}}),d.on("keyup",function(){p&&(h(p),p=!1)}),d.on("focus",function(){var e;l=!0,d.dom.addClass(d.getBody(),"has-focus"),m&&(e=C(d.getBody().firstChild))&&y(!0,e),m=!1}),d.on("blur",function(){l=!1,d.dom.removeClass(d.getBody(),"has-focus")}),d.on("NodeChange",function(e){var t=d.dom,n=d.dom.select(".evo-view-wrap"),o=e.element.className,i=C(e.element),a=g;if(g=!1,clearInterval(r),tinymce.each(n,function(e){e.className&&(e.className=e.className.replace(/ ?\bevo-view-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),l&&i)if("evo-view-selection-before"!==o&&"evo-view-selection-after"!==o||!d.selection.isCollapsed())w(e.element,"evo-view-clipboard")||s||(x(),s++,y(!0,i));else{if(s=0,x(),a===i.previousSibling)return void y(!0,i);if(a===i.nextSibling)return void y(!1,i);t.addClass(i,o),r=setInterval(function(){t.hasClass(i,"evo-view-cursor-hide")?t.removeClass(i,"evo-view-cursor-hide"):t.addClass(i,"evo-view-cursor-hide")},500)}}),d.on("BeforeExecCommand",function(){var e,t=d.selection.getNode();t&&((o="evo-view-selection-before"===t.className)||"evo-view-selection-after"===t.className)&&(e=C(t))&&(P(e,o),n=e)}),d.on("ExecCommand",function(){var e,t;u&&(e=u,x(),D(e)),n&&((t=n[o?"previousSibling":"nextSibling"])&&"P"===t.nodeName&&d.dom.isEmpty(t)&&(d.dom.remove(t),y(o,n)),n=!1)}),d.on("ResolveName",function(e){d.dom.hasClass(e.target,"evo-view-wrap")?(e.name=d.dom.getAttrib(e.target,"data-evo-view-type")||"evo-view",e.stopPropagation()):C(e.target)&&(e.preventDefault(),e.stopPropagation())}),d.addButton("evo_image",{text:"inline image",icon:!1,tooltip:evo_js_lang_edit_image,onclick:function(){switch(d.getParam("target_type")){case"Item":if(!d.getParam("target_ID")&&!d.getParam("temp_ID"))return alert(evo_js_lang_alert_before_insert_item),!1;break;case"Comment":if(!d.getParam("target_ID"))return alert(evo_js_lang_alert_before_insert_comment),!1;break;case"EmailCampaign":if(!d.getParam("target_ID"))return alert(evo_js_lang_alert_before_insert_emailcampaign),!1;break;case"Message":if(!d.getParam("target_ID")&&!d.getParam("temp_ID"))return alert(evo_js_lang_alert_before_insert_message),!1}e()},onPostRender:function(){var o=this;d.on("NodeChange",function(e){var t;i&&(t=i.getAttribute("data-evo-view-type"));var n=-1!=_.indexOf(t);o.active(n)})}}),d.on("evotoolbar",function(e){u&&(e.element=u,e.toolbar=void 0)}),d.evo=d.evo||{},d.evo.getView=C,d.evo.setViewCursor=y,d.addCommand("evo_view_edit_inline",function(){e()}),{getView:C,editView:e}});